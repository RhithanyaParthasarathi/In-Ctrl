<div class="analysis-container">
    <div class="header"
        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
        <div class="header-text">
            <h2>Analysis Results</h2>
            <p *ngIf="commitUrl">Reviewing AI analysis for: <a [href]="commitUrl" target="_blank" class="commit-link">{{
                    commitUrl.split('/').pop()?.substring(0, 7) || 'Commit' }}</a></p>
            <p *ngIf="!commitUrl">Reviewing AI analysis.</p>
            <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                <a routerLink="/analyze" class="back-link">&larr; Back to Ingester</a>
            </div>
        </div>

        <!-- Right side: Tabs + Tag button stacked -->
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;" *ngIf="analysis">
            <!-- TAB NAVIGATION STRIP -->
            <div class="tabs-nav">
                <button class="tab-btn" [class.active]="activeTab === 'summary'" (click)="setActiveTab('summary')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Logic Summary
                </button>
                <button class="tab-btn" [class.active]="activeTab === 'alternatives'"
                    (click)="setActiveTab('alternatives')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8l4 4-4 4M8 12h8"></path>
                    </svg>
                    Alternative Paths
                </button>
                <button class="tab-btn" [class.active]="activeTab === 'faults'" (click)="setActiveTab('faults')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                        </path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Fracture Points
                </button>
            </div>

            <!-- Tag Analysis button sits right-aligned directly below tabs -->
            <button class="btn-primary" (click)="openTagModal()"
                style="padding: 0.4rem 1rem; font-size: 0.85rem; border-radius: 6px; display: flex; align-items: center; gap: 6px; background: rgba(56, 189, 248, 0.08); border: 1px solid rgba(56, 189, 248, 0.3); color: #38bdf8;">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
                Tag Analysis
            </button>
        </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!analysis" class="card empty-state">
        <div class="feature-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
        </div>
        <h3>No Analysis Data Found</h3>
        <p>You haven't run an analysis yet, or your session data was cleared.</p>
        <a routerLink="/analyze" class="btn-primary"
            style="display: inline-block; width: auto; text-decoration: none;">Go to Ingester</a>
    </div>

    <!-- Analysis Dashboard -->
    <div *ngIf="analysis" class="dashboard-grid">

        <!-- Left Column: Tabbed Content (Summary, Alternatives, Faults) and Chat -->
        <div class="left-column">

            <!-- TAB 1: LOGIC SUMMARY -->
            <div class="card summary-card tab-pane" *ngIf="activeTab === 'summary'">
                <div class="card-header">
                    <span class="icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <h3>Logic Summary</h3>
                </div>
                <div class="card-body">
                    <p class="summary-text">{{ analysis.summary }}</p>

                    <div class="tech-stack">
                        <h4>Technologies Detected:</h4>
                        <div class="tags">
                            <span class="tag" *ngFor="let tech of analysis.technologies">{{ tech }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: ALTERNATIVE PATHS -->
            <div class="card alternatives-card tab-pane" *ngIf="activeTab === 'alternatives'">
                <div class="card-header">
                    <span class="icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f472b6" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 8l4 4-4 4M8 12h8"></path>
                        </svg>
                    </span>
                    <h3>Alternative Paths Considered</h3>
                </div>
                <div class="card-body">
                    <div class="alternative-item" *ngFor="let alt of analysis.alternatives">
                        <h4 class="alt-method">{{ alt.method }}</h4>
                        <p class="alt-justification">{{ alt.justification }}</p>
                    </div>
                </div>
                <div class="card-notes">
                    <div class="dev-input-section">
                        <label class="dev-input-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ec4899"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="vertical-align: text-bottom; margin-right: 4px;">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Your Notes &mdash; Acknowledge and note anything about these alternatives
                        </label>
                        <textarea class="dev-textarea" [(ngModel)]="alternativesNote" rows="3"
                            placeholder="Why you chose your current approach, trade-offs considered, etc..."></textarea>
                    </div>
                </div>
            </div>

            <!-- TAB 3: FRACTURE POINTS -->
            <div class="card faults-card tab-pane" *ngIf="activeTab === 'faults'">
                <div class="card-header">
                    <span class="icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                            </path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </span>
                    <h3>Potential Fracture Points</h3>
                </div>
                <div class="card-body">
                    <div class="fault-item" *ngFor="let fault of analysis.faults; let i = index">
                        <h4 class="fault-point">
                            <span class="icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fca5a5"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <circle cx="12" cy="12" r="6"></circle>
                                    <circle cx="12" cy="12" r="2"></circle>
                                </svg>
                            </span>
                            {{ fault.point }}
                        </h4>
                        <p class="fault-risk">{{ fault.risk }}</p>
                        <div class="dev-input-section">
                            <label class="dev-input-label">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    style="vertical-align: text-bottom; margin-right: 4px;">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                Your Mitigation Plan — How will you address this risk?
                            </label>
                            <textarea class="dev-textarea fault-textarea" [(ngModel)]="faultMitigations[i]" rows="3"
                                placeholder="Document your safety plan or mitigation strategy for this risk..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- End of Tab Panes -->
        </div>

        <!-- Right Column: AI Chat & Notes -->
        <div class="right-column">

            <!-- Commit D & E: AI Q&A Chat -->
            <div class="card chat-card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <span class="icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </span>
                    <h3>Ask About This Commit</h3>
                </div>

                <!-- Messages Window -->
                <div class="chat-messages" id="chatWindow">
                    <div *ngIf="chatMessages.length === 0" class="chat-placeholder">
                        <p>Ask anything about this commit — technologies used, why a pattern was chosen,
                            potential risks, etc.</p>
                    </div>
                    <div *ngFor="let msg of chatMessages" class="chat-bubble"
                        [ngClass]="msg.role === 'user' ? 'bubble-user' : 'bubble-ai'">
                        <div *ngIf="msg.role === 'ai'" [innerHTML]="msg.content" class="markdown-body"></div>
                        <span *ngIf="msg.role === 'user'">{{ msg.content }}</span>
                    </div>
                    <div *ngIf="isChatLoading" class="chat-bubble bubble-ai loading-bubble">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>

                <!-- Input Row -->
                <div class="chat-input-row">
                    <textarea class="chat-input" [(ngModel)]="currentQuestion" (keydown)="onChatKeydown($event)"
                        placeholder="e.g. Why was JPA used instead of JDBC here?" rows="2" [disabled]="isChatLoading">
                    </textarea>
                    <button class="chat-send-btn" (click)="sendChatMessage()"
                        [disabled]="isChatLoading || !currentQuestion.trim()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Keep Notes Interface -->
            <div class="keep-container">
                <div class="keep-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: #e2e8f0; font-size: 1.1rem; margin: 0;">{{ activeTab === 'summary' ? 'Logic
                        Summary' : activeTab === 'alternatives' ? 'Alternative Paths' : 'Fracture Points' }} Notes</h3>
                    <span class="notes-save-message"
                        [ngClass]="notesSavedMessage.includes('⚠️') ? 'save-error' : 'save-success'"
                        style="display: flex; align-items: center; gap: 6px;">
                        <svg *ngIf="notesSavedMessage === 'Saved'" width="16" height="16" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span>{{ notesSavedMessage }}</span>
                    </span>
                </div>

                <!-- Take a note input -->
                <div class="keep-take-note" [class.expanded]="isNoteInputExpanded">
                    <textarea *ngIf="isNoteInputExpanded" class="keep-title-input" [(ngModel)]="newNoteTitle"
                        placeholder="Title"></textarea>
                    <textarea class="keep-content-input" [(ngModel)]="newNoteContent" placeholder="Take a note..."
                        (focus)="isNoteInputExpanded = true" [rows]="isNoteInputExpanded ? 3 : 1"></textarea>

                    <div class="keep-note-actions" *ngIf="isNoteInputExpanded">
                        <span style="font-size: 0.75rem; color: #64748b; padding: 0 4px;">
                            {{ newNoteContent.length }} chars
                        </span>
                        <button class="keep-btn-save" (click)="addNote()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Save
                        </button>
                    </div>
                </div>

                <!-- Notes Masonry Grid -->
                <div class="keep-notes-grid">
                    <div class="keep-note-card" *ngFor="let note of parsedNotes; let i = index"
                        (click)="openNoteForViewing(i)">
                        <div class="keep-card-title" *ngIf="note.title">{{ note.title }}</div>
                        <div class="keep-card-content">{{ note.content }}</div>
                        <div class="keep-card-actions">
                            <button class="keep-icon-btn" (click)="deleteNote(i, $event)" title="Delete note">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444"
                                    stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Global Acknowledgement and Save Analysis Section -->
    <div style="margin-top: 3rem; margin-bottom: 3rem; display: flex; flex-direction: column; align-items: center; gap: 1.5rem;"
        *ngIf="analysis">

        <!-- Acknowledgement Box -->
        <div class="global-ack-box" [ngClass]="{'acknowledged': hasAcknowledged}"
            style="display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem 2rem; border-radius: 8px; width: fit-content; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5);">
            <ng-container *ngIf="!hasAcknowledged">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"
                    style="margin-right: 8px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span style="font-weight: 500; font-size: 0.95rem; margin-right: 1.5rem; color: #cbd5e1;">I must declare
                    that I understand the code logic involved in this commit.</span>
                <button class="btn-acknowledge-gradient" (click)="onAcknowledge()"
                    style="background: linear-gradient(135deg, #0ea5e9, #10b981); color: white; border: none; padding: 0.5rem 1.25rem; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.9rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); transition: opacity 0.2s;"
                    onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">I Acknowledge</button>
            </ng-container>
            <ng-container *ngIf="hasAcknowledged">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2"
                    style="margin-right: 8px;">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <span style="font-weight: 600; font-size: 0.95rem; color: #34d399;">Acknowledged Mastered Logic</span>
            </ng-container>
        </div>

        <button class="btn-primary" (click)="openTagModal()"
            style="padding: 0.5rem 1.5rem; font-size: 0.95rem; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); display: inline-flex; align-items: center; gap: 6px; width: auto;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save Analysis
        </button>
    </div>

</div>

<!-- Expanded Note View Modal -->
<div class="modal-overlay" *ngIf="expandedNoteIndex !== null" (click)="closeNoteViewing()">
    <div class="modal-content keep-expanded-modal card" (click)="$event.stopPropagation();"
        style="width: 600px; max-width: 90vw; padding: 10px;">

        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem 1rem;">
            <div style="flex-grow: 1;">
                <input type="text" class="keep-title-input" [(ngModel)]="parsedNotes[expandedNoteIndex].title"
                    placeholder="Title"
                    style="font-size: 1.25rem; font-weight: 500; background: transparent; border: none; color: #f1f5f9; outline: none; width: 100%;">
            </div>
            <button (click)="saveNotes(activeTab); closeNoteViewing()"
                style="background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%;">&times;</button>
        </div>

        <div style="padding: 0 1rem 1rem 1rem;">
            <textarea class="keep-content-input" [(ngModel)]="parsedNotes[expandedNoteIndex].content"
                placeholder="Take a note..." rows="12"
                style="font-size: 1.05rem; background: transparent; border: none; color: #cbd5e1; outline: none; width: 100%; resize: none; scrollbar-width: thin; scrollbar-color: rgba(139, 92, 246, 0.3) transparent;"></textarea>
        </div>

        <div
            style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem 0.5rem 1rem; border-top: 1px solid rgba(51, 65, 85, 0.5);">
            <div class="keep-actions" style="display: flex; align-items: center; gap: 1rem;">
                <button class="keep-icon-btn" (click)="deleteNoteFromView(expandedNoteIndex)" title="Delete note">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
                <span class="notes-save-message"
                    [ngClass]="notesSavedMessage.includes('⚠️') ? 'save-error' : 'save-success'"
                    style="font-size: 0.85rem; display: flex; align-items: center; gap: 6px;">
                    <svg *ngIf="notesSavedMessage === 'Saved'" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>{{ notesSavedMessage }}</span>
                </span>
            </div>
            <button class="btn-primary" (click)="saveNotes(activeTab); closeNoteViewing()"
                style="padding: 0.5rem 1.5rem; font-size: 0.9rem; border-radius: 6px;">Done</button>
        </div>
    </div>
</div>

<!-- Modal for Commit Tag -->
<div class="modal-overlay" *ngIf="showTagModal">
    <div class="modal-content card" style="width: 400px; padding: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: #f1f5f9; margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
                Save & Tag Analysis
            </h3>
            <button (click)="closeTagModal()"
                style="background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 1.2rem;">&times;</button>
        </div>

        <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 1rem;">Provide a short phrase or tag to easily
            identify this commit analysis in the History tab later.</p>

        <label class="dev-input-label"
            style="display: block; margin-bottom: 0.5rem; color: #e2e8f0; font-weight: 500;">Commit Tag</label>
        <input type="text" [(ngModel)]="commitTag" placeholder="e.g. Auth Feature, Hotfix"
            style="width: 100%; background: rgba(15, 23, 42, 0.4); border: 1px solid #334155; color: #fff; padding: 0.6rem 1rem; border-radius: 6px; outline: none; transition: border-color 0.2s; margin-bottom: 1rem;"
            onfocus="this.style.borderColor='#38bdf8'" onblur="this.style.borderColor='#334155'">

        <div style="display: flex; justify-content: flex-end; gap: 0.8rem; align-items: center;">
            <span
                [style.color]="tagSavedMessage.includes('✅') ? '#34d399' : (tagSavedMessage.includes('⚠️') ? '#f87171' : '#94a3b8')"
                style="font-size: 0.85rem;">
                {{ tagSavedMessage }}
            </span>
            <button class="btn-secondary" (click)="closeTagModal()" [disabled]="isTagSaving"
                style="padding: 0.5rem 1rem; font-size: 0.9rem; background: transparent; border: 1px solid #475569; color: #cbd5e1;">Cancel</button>
            <button class="btn-primary" (click)="saveCommitTag()" [disabled]="isTagSaving"
                style="padding: 0.5rem 1.5rem; font-size: 0.9rem; border-radius: 6px;">
                {{ isTagSaving ? 'Saving...' : 'Save Tag' }}
            </button>
        </div>
    </div>
</div>