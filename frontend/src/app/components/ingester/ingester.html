<div class="ingester-layout">
  <div class="main-content">
    <div class="ingester-container">
      <div class="header">
        <h1>In-Ctrl: Verification Documentor</h1>
        <p>Ingest the latest code and AI context.</p>
      </div>

      <div class="card">
        <!-- Mode Toggle -->
        <div class="mode-toggle">
          <button class="toggle-btn" [class.active]="inputMode === 'repo'" (click)="inputMode = 'repo'">
            üîç Browse Repository
          </button>
          <button class="toggle-btn" [class.active]="inputMode === 'manual'" (click)="inputMode = 'manual'">
            üîó Paste Commit URL
          </button>
        </div>

        <!-- PRIMARY: Repo Selector Mode -->
        <div *ngIf="inputMode === 'repo'">
          <div class="form-group">
            <label for="repoUrl">GitHub Repository URL <span class="required">*</span></label>
            <div class="input-with-button">
              <input type="text" id="repoUrl" [(ngModel)]="repoUrl" placeholder="e.g., https://github.com/owner/repo"
                class="form-control">
              <button class="btn-fetch" (click)="fetchCommits()" [disabled]="isFetchingCommits || !repoUrl">
                {{ isFetchingCommits ? 'Fetching...' : 'Fetch Commits' }}
              </button>
            </div>
            <small>Enter a public GitHub repository to browse its recent commits.</small>
          </div>

          <!-- Fetch Error -->
          <div class="alert error" *ngIf="fetchError">
            <strong>Error:</strong> {{ fetchError }}
          </div>

          <!-- Loading Spinner -->
          <div class="commits-loading" *ngIf="isFetchingCommits">
            <div class="loading-spinner"></div>
            <span>Loading commits...</span>
          </div>

          <!-- Commit List -->
          <div class="commit-list" *ngIf="commits.length > 0">
            <label class="commit-list-label">Select a Commit to Analyze:</label>
            <div class="commit-item" *ngFor="let commit of commits"
              [class.selected]="selectedCommit?.sha === commit.sha" (click)="selectCommit(commit)">
              <div class="commit-radio">
                <span class="radio-dot" [class.active]="selectedCommit?.sha === commit.sha"></span>
              </div>
              <div class="commit-details">
                <div class="commit-message">{{ truncateMessage(commit.message) }}</div>
                <div class="commit-meta">
                  <span class="commit-sha">{{ commit.sha.substring(0, 7) }}</span>
                  <span class="commit-author">{{ commit.authorName }}</span>
                  <span class="commit-date">{{ formatDate(commit.date) }}</span>
                </div>
              </div>
            </div>

            <!-- Load More Button -->
            <div class="load-more-container" *ngIf="commits.length > 0 && hasMoreCommits"
              style="margin-top: 15px; text-align: center;">
              <button class="btn-secondary" (click)="fetchCommits(true)" [disabled]="isFetchingCommits"
                style="background: transparent; border: 1px solid #4a5568; color: #e2e8f0; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                {{ isFetchingCommits ? 'Loading...' : 'Load More Commits' }}
              </button>
            </div>
          </div>
        </div>

        <!-- FALLBACK: Manual URL Mode -->
        <div *ngIf="inputMode === 'manual'">
          <div class="form-group">
            <label for="githubUrl">GitHub Commit URL <span class="required">*</span></label>
            <input type="text" id="githubUrl" [(ngModel)]="githubUrl"
              placeholder="e.g., https://github.com/owner/repo/commit/sha" class="form-control">
            <small>Paste the direct URL to the commit you want to audit.</small>
          </div>
        </div>

        <!-- AI Chat Context (shared between both modes) -->
        <div class="form-group">
          <label for="aiChatLog">AI Chat Context (Optional)</label>
          <textarea id="aiChatLog" [(ngModel)]="aiChatLog" rows="6"
            placeholder="Paste your conversation with the AI (ChatGPT, Claude, Gemini) that led to these code changes..."
            class="form-control"></textarea>
          <small>This context helps the system understand the *intent* behind the code.</small>
        </div>

        <button class="btn-primary btn-analyze" (click)="onSubmit()"
          [disabled]="isLoading || (inputMode === 'repo' && !selectedCommit) || (inputMode === 'manual' && !githubUrl)"
          [class.loading]="isLoading">
          <ng-container *ngIf="!isLoading">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              style="margin-right: 8px;">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            Analyze Commit &amp; Context
          </ng-container>
          <ng-container *ngIf="isLoading">
            <svg class="spin-ring" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2.5" style="margin-right: 8px;">
              <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"></path>
            </svg>
            Analyzing...
          </ng-container>
        </button>

        <!-- Loading progress indicator below button -->
        <div class="analyze-progress" *ngIf="isLoading">
          <div class="progress-track">
            <div class="progress-shimmer"></div>
          </div>
          <p class="progress-label">AI is analyzing your commit ‚Äî this may take 15‚Äì30 seconds ‚ú®</p>
        </div>
      </div>

      <!-- Error Message Display -->
      <div class="alert error" *ngIf="errorMessage">
        <strong>Error:</strong> {{ errorMessage }}
      </div>

    </div>
  </div>

  <!-- Sidebar: Navigation & Saved Repositories -->
  <div class="sidebar">
    <div class="sidebar-section">
      <h3>Navigation</h3>
      <a routerLink="/history" class="history-nav-card">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="nav-text">
          <h4>View Saved History</h4>
          <p>Browse your past AI analyses</p>
        </div>
        <div class="nav-arrow">&rarr;</div>
      </a>
    </div>

    <div *ngIf="savedRepos.length > 0">
      <h3>Saved Repositories</h3>
      <p class="sidebar-desc">Click to quickly reload a repository.</p>

      <div class="saved-repo-list">
        <div class="saved-repo-card" *ngFor="let repo of savedRepos" (click)="useSavedRepo(repo)">
          <div class="repo-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
            </svg>
          </div>
          <div class="repo-url" [title]="repo">{{ repo.replace('https://github.com/', '') }}</div>
        </div>
      </div>
    </div>
  </div>